<div class="container mt-4">
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h1><%= t('.notification_settings_for_project') %></h1>
      <div>
        <%= link_to t('.back_to_user_settings'), users_job_notifications_path(@user), class: "btn btn-outline-secondary mr-2" %>
        <%= link_to t('.to_project'), project_path(@project), class: "btn btn-outline-primary" %>
      </div>
    </div>
    <p class="lead"><%= t('.project_info', project_title: @project.title, user_email: @user.email).html_safe %></p>
  </div>

  <div class="alert alert-info">
    <strong><%= t('.info') %>:</strong> <%= t('.settings_description') %>
  </div>

  <div class="card">
    <div class="card-body">
      <% if @notifications.any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th><%= t('.notification') %></th>
                <th><%= t('.telegram') %></th>
                <th><%= t('.email') %></th>
                <th><%= t('.stop_job') %></th>
                <th><%= t('.settings_type') %></th>
                <th><%= t('.actions') %></th>
              </tr>
            </thead>
            <tbody>
              <% @notifications.each do |notification| %>
                <%
                  project_setting = @project_settings[notification.id]
                  user_default = @user_defaults[notification.id]
                  global_default = notification.global_default

                  if project_setting
                    settings_type = "project"
                    notify_tg = project_setting.notify_tg.nil? ? (user_default ? user_default.notify_tg : global_default.notify_tg) : project_setting.notify_tg
                    notify_mail = project_setting.notify_mail.nil? ? (user_default ? user_default.notify_mail : global_default.notify_mail) : project_setting.notify_mail
                    kill_job = project_setting.kill_job.nil? ? (user_default ? user_default.kill_job : global_default.kill_job) : project_setting.kill_job
                  elsif user_default
                    settings_type = "user"
                    notify_tg = user_default.notify_tg.nil? ? global_default.notify_tg : user_default.notify_tg
                    notify_mail = user_default.notify_mail.nil? ? global_default.notify_mail : user_default.notify_mail
                    kill_job = user_default.kill_job.nil? ? global_default.kill_job : user_default.kill_job
                  else
                    settings_type = "global"
                    notify_tg = global_default.notify_tg
                    notify_mail = global_default.notify_mail
                    kill_job = global_default.kill_job
                  end
                %>

                <tr>
                  <td><%= notification.name %></td>
                  <td>
                    <% badge_class = settings_type == "global" ? "badge-secondary" : (settings_type == "user" ? "badge-info" : "badge-primary") %>
                    <% badge_class = notify_tg ? "#{badge_class}" : "badge-danger" %>
                    <span class="badge <%= badge_class %>">
                      <%= notify_tg ? t('.yes') : t('.no') %>
                    </span>
                  </td>

                  <td>
                    <% badge_class = settings_type == "global" ? "badge-secondary" : (settings_type == "user" ? "badge-info" : "badge-primary") %>
                    <% badge_class = notify_mail ? "#{badge_class}" : "badge-danger" %>
                    <span class="badge <%= badge_class %>">
                      <%= notify_mail ? t('.yes') : t('.no') %>
                    </span>
                  </td>

                  <td>
                    <% badge_class = settings_type == "global" ? "badge-secondary" : (settings_type == "user" ? "badge-info" : "badge-primary") %>
                    <% badge_class = kill_job ? "#{badge_class}" : "badge-danger" %>
                    <span class="badge <%= badge_class %>">
                      <%= kill_job ? t('.yes') : t('.no') %>
                    </span>
                  </td>

                  <td>
                    <% if settings_type == "project" %>
                      <span class="badge badge-primary"><%= t('.project') %></span>
                    <% elsif settings_type == "user" %>
                      <span class="badge badge-info"><%= t('.user') %></span>
                    <% else %>
                      <span class="badge badge-secondary"><%= t('.global') %></span>
                    <% end %>
                  </td>

                  <td>
                    <div class="btn-group">
                      <% if project_setting %>
                        <%= link_to t('.edit'), edit_job_notification_job_notification_project_setting_path(notification, user_id: @user.id, project_id: @project.id, id: project_setting.id), class: "btn btn-sm btn-warning" %>
                        <%= link_to t('.reset'), job_notification_job_notification_project_setting_path(notification, user_id: @user.id, project_id: @project.id, id: project_setting.id),
                                      method: :delete,
                                      data: { confirm: t('.reset_confirmation') },
                                      class: "btn btn-sm btn-outline-danger" %>
                      <% else %>
                        <%= link_to t('.configure_for_project'), new_job_notification_job_notification_project_setting_path(notification, user_id: @user.id, project_id: @project.id), class: "btn btn-sm btn-primary" %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info">
          <%= t('.no_notifications') %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="mt-4">
    <div class="card bg-light">
      <div class="card-body">
        <h3 class="card-title"><%= t('.legend') %></h3>

        <div class="row">
          <div class="col-md-4">
            <h5><%= t('.settings_source') %>:</h5>
            <ul class="list-unstyled">
              <li><span class="badge badge-primary"><%= t('.project') %></span> - <%= t('.project_source_description') %></li>
              <li><span class="badge badge-info"><%= t('.user') %></span> - <%= t('.user_source_description') %></li>
              <li><span class="badge badge-secondary"><%= t('.global') %></span> - <%= t('.global_source_description') %></li>
            </ul>
          </div>

          <div class="col-md-4">
            <h5><%= t('.settings_status') %>:</h5>
            <ul class="list-unstyled">
              <li><span class="badge badge-success"><%= t('.yes') %></span> - <%= t('.option_enabled') %></li>
              <li><span class="badge badge-danger"><%= t('.no') %></span> - <%= t('.option_disabled') %></li>
            </ul>
          </div>

          <div class="col-md-4">
            <h5><%= t('.actions') %>:</h5>
            <ul class="list-unstyled">
              <li><span class="btn btn-sm btn-primary disabled"><%= t('.configure_for_project') %></span> - <%= t('.configure_for_project_description') %></li>
              <li><span class="btn btn-sm btn-warning disabled"><%= t('.edit') %></span> - <%= t('.edit_description') %></li>
              <li><span class="btn btn-sm btn-outline-danger disabled"><%= t('.reset') %></span> - <%= t('.reset_description') %></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
