# Вступление
Модуль комментариев позволяет прикреплять текстовые комментарии,теги и файлы(далее будем называть их одним словом -- заметки) к любому объекту в Octoshell. Также модуль обладает системой прав для модерации комментарий.
# Интеграция в коде
Для интеграции достаточно во view в месте, где Вам нужно отобразить заметки, вызвать метод render_attachments (attachable, attachment_type), где attachable -- объект класса ActiveRecord::Relation, массив объектов ActiveRecord::Base или класс-наследник ActiveRecord::Base (например, Core::Project), а attachment_type -- одно из следующих значений: :comments, :files, :tags или любой другой объект, который при явном приведении к String методом to_s имеет одно из следующих значений: 'comments', 'files', 'tags'.

##### Пример в slim:
``` slim
- @projects = Core::Project.all
= render_attachments(@projects,:tags)
= render_attachments(Core::Project,:tags)
```
# В production!

Для работы в окружении production необходимо изменить конфигурацию nginx и production.rb, т.к. в модуле перед отдачей  файла проверяется наличие доступа пользователя к нему. При этом хотелось бы, чтобы сам файл отдавал nginx(он же быстрее). Работает это так: nginx добавляет заголовки в запрос X-Accel-Redirect и X-Accel-Mapping, rails, обнаружив этот заголовок, при успешной авторизации перенаправляет запрос nginx на приватный url (для данного модуля /secured_uploads). Защищаемые файлы записываются в директорию secured_uploads.  Этот механизм подробнее изложен [здесь](https://coderwall.com/p/o0alkq/serving-protected-static-content-using-nginx-for-speed-and-rails-server-for-authentication).

Пример конфигурации nginx:

``` nginx
upstream app {
    server localhost:5000;
}
server {
    listen 9000;
    root /home/andrey/octoshell/public;
    location /{
      try_files $uri @app;
    }
   location /secured_uploads/{
      alias   /home/andrey/octoshell/;  # Append the path with /
      internal;   # Can't access this directory from direct access from the web
   }
    location @app {
        proxy_pass http://app;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header  X-Sendfile-Type  X-Accel-Redirect;
        proxy_set_header  X-Accel-Mapping  /home/andrey/octoshell/=/secured_uploads/;
    }
    error_page 500 502 503 504 /500.html;
    client_max_body_size 4G;
    keepalive_timeout 10;
}
```

В production.rb обязательно должны быть следующие строки:

``` ruby
  config.assets.js_compressor = Uglifier.new(harmony: true) # Поддержка ES6
  config.action_dispatch.x_sendfile_header = 'X-Accel-Redirect' # for nginx
  config.middleware.insert(0, Rack::Sendfile, config.action_dispatch.x_sendfile_header)
```

Прекомпиляция командой rake assets:precompile javascript-файлов может занимать довольно много времени, а иногда и занимать слишком много памяти для Вашей машины. При установленном NodeJS можно ускорить этот процесс следующей командой:
``` bash
  RAILS_ENV=production bundle exec rake assets:precompile EXECJS_RUNTIME='Node' JRUBY_OPTS="-J-d32 -X-C"
 ```
Во многом автоматическая установка:
``` bash
   source  engines/core/scripts/bash/merge/install.sh
```


 Необходимо создать справку по работе с модулем. В эту справку копируется содержимое данного файла, начиная со строки "Правила доступа к заметкам"
``` bash
   RAILS_ENV=production rake comments:create_wiki_page
```


# Правила доступа к заметкам

## Краткий обзор
Правила для заметок (комментариев, тегов и файлов) делятся на два типа:

1. Без контекста

   На права пользователя к данной заметке оказывает влияние только объект.

2. С контекстом

   На права пользователя к данной заметке оказывает влияние только контекст. Контексты - некоторые заранее  определенные объекты (их можно определить в панели администратора), имеющие только один атрибут: название.
   Они связаны с группами пользователей.
   Контекст позволяет создавать, например, админские комментарии.

Для объектов правила определяются пятеркой <Класс, Объект, разрешающее ли, группа пользователей,тип правила>.

* Объект может отсутствовать - это правило соответствует всем объектам.
* Группа может тоже не присутствовать - это особое правило, которое называется правилом по умолчанию.
* Тип правила: создание, создание с контекстом, чтение, редактирование.

Для контекста правила определяются четвертой <контекст, разрешающее ли, группа пользователей,тип правила>.
* Тип правила: создание (с данным контекстом), чтение, редактирование.

## Создание и создание с контекстом
  Чтобы пользователь мог создавать приложения (создавать приложения с контекстом) для объекта   обязательно для этого объекта или для его класса должно быть создано правило создания (с контекстом) по умолчанию.
  * Если оно разрешающее, то  хотя бы для одной  группы для этого объекта(или его класса) не должно найтись запрещающее правило(либо не существует, либо разрешающее).
  * Если оно запрещающее, то  хотя бы для одной  группы для этого объекта(или его класса) должно найтись разрешающее правило.

  Если пользователь хочет прикрепить приложение с определенным контекстом, то, помимо права на создание приложения с контекстом для объекта, он еще должен обладать правом записи в желаемый контекст.

## Чтение и редактирование
  Пользователь может редактировать свои приложения.

#### Чтение и редактирование приложений без контекста
  Чтобы пользователь мог читать (редактировать) приложения без контекста объекта обязательно для этого объекта или для его класса должно быть создано правило создания (с контекстом) по умолчанию.
  * Если оно разрешающее, то  хотя бы для одной  группы для этого объекта(или его класса) не должно найтись запрещающее правило (либо не существует, либо разрешающее).
  * Если оно запрещающее, то  хотя бы для одной  группы для этого объекта(или его класса) должно найтись разрешающее правило.

#### Чтение и редактирование приложений с контекстом
  Здесь всё проще: пользователь должен обладать только соответствующим правом для контекста. Контекст приложения можно изменять, но так как это эквивалентно уничтожению приложения и созданию нового, то это действие определяется соответствующими правилами создания.

## Алгоритм получения заметок

#### На входе:

  * id пользователя;
  * массив объектов, заметки к которым необходимо получить пользователю

#### На выходе:

  * Массив заметок

#### Шаги алгоритма:

  1. Найти права чтения по умолчанию для заданных объектов, т. е. права чтения для самих объектов и их классов
  2. Найти все заметки без контекста для заданных объектов
  3. Для каждой заметки, полученной на шаге 2:

  3.1 Если есть запрет по умолчанию для объекта или его класса, и пользователь принадлежит хотя бы к одной группе, которой разрешен просмотр для объекта или его класса, то добавить заметку к выходному массиву

  3.2 Иначе если есть право по умолчанию для объекта или его класса, и пользователь принадлежит хотя бы к одной группе, для которой не существует запрета на просмотр заметки, то добавить заметку к выходному массиву
  4. Найти все заметки с контекстами для заданных объектов
  5. Для каждой заметки, полученной на шаге 4:

  5.1 Если для контекста заметки хотя бы одной группе или пользователю разрешен просмотр, добавить заметку к выходному массиву.
