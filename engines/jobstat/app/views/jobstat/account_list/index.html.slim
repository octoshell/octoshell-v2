- @js_jobs='var jobs={'+@jobs_plus.map{|i,j| "'#{i}':{'login':'#{j["login"]}', 'cluster':'#{j["cluster"]}', 'state':'#{j["state"]}', 'rules':#{j["rules"]}}"}.join(',')+'};'
- @rule_pictures=(@pictures || {}).map{|name,value| "rule_pictures['#{name}']='<i class=\"#{value} typewritter\"></i>';"}.join("\n")
- @finish_states={'COMPLETED'=>'far fa-grin-beam','NODE_FAIL'=>'far fa-grimace','FAILED'=>'far fa-frown','CANCELLED'=>'far fa-meh-rolling-eyes','TIMEOUT'=>'far fa-flushed'} 
// pass ruby variables to js
javascript:
  #{{@js_jobs}}

  var rule_pictures={}
  #{{@rule_pictures}}
  var jobs_feedback=#{@jobs_feedback}
  var current_user=#{@current_user.id}

  var rule_pic_other = '<i class="fas fa-fw fa-exclamation-triangle" title="......"></i>'
  // {user:int, cluster: string, job_id: int, task_id: int, class=int, feedback=string},{...}

//script type="text/javascript" src="https://raw.githubusercontent.com/Mottie/tablesorter/master/js/jquery.tablesorter.js"
//script type="text/javascript" src="/jquery.tablesorter.js"

link rel="stylesheet" type="text/css" href="/theme.blue.css"
link rel="stylesheet" type="text/css" href="/assets/jobstat/jobs.css"

h3 = "Job table query interface"

= render "form"

- if @notice
  p style = 'color:#FF0000;' = @notice

div
  button onClick='agree_all()' id='agree_all'
    | Ð¯ ÑÐ¾Ð³Ð»Ð°ÑÐµÐ½ Ñ Ð¾Ñ†ÐµÐ½ÐºÐ°Ð¼Ð¸ Ð¼Ð¾Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
  | ÐÐµ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ñ‹ Ñ Ð¾Ñ†ÐµÐ½ÐºÐ¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²?  
  div id='disagree_reason_box' style="display: none; width: 100%" class="feedback_div"
    br
    | Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð½Ð¸Ð¶Ðµ (Ð»ÐµÐ²Ñ‹Ð¹ ÑÑ‚Ð¾Ð»Ð±ÐµÑ†), Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð»Ð¸ Ð½ÐµÐ²ÐµÑ€Ð½Ð¾ (Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð½Ð¸Ð¶Ðµ):
    div style="width: 100%" id="disagree_rules" class="feedback_list"
      | - ÐŸÐ¾ÐºÐ° Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹ Ð·Ð°Ð´Ð°Ñ‡Ð¸, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð½ÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»...
    br
    | ÐŸÐ¾ÑÑÐ½Ð¸Ñ‚Ðµ, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð’Ñ‹ Ð½Ðµ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ñ‹ Ñ ÑÑ‚Ð¸Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼Ð¸?
    input type='text' id='disagree_reason' style="right: 0px; width: 99%"
    br
  button id="disagree_button" onClick="multi_job_feedback()" alt="ÐÐµ ÑÐ¾Ð³Ð»Ð°ÑÐµÐ½!"
    | Ð–Ð¼Ð¸Ñ‚Ðµ Ñ‚ÑƒÑ‚!
  div
    | Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ, ÑÐºÑ€Ñ‹Ñ‚ÑŒ Ð¸Ñ… Ð²Ð¸Ð´Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ñ… Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ðº Ð·Ð°Ð´Ð°Ð½Ð¸ÑŽ, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¿ÐµÑ€Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹.
    br
    a href='/jobstat/rules_summary' Ð’Ð¾Ñ‚ Ð·Ð´ÐµÑÑŒ
    | Ð¿Ð¾Ð»Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ð¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ð¼ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ñ… Ð²Ð¸Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸.
div
  /p
    | Sort by &nbsp;
    a class="btn btn-info sorting" data-column="8" data-direction="0" data-item="0" num nodes
    | &nbsp;
    a class="btn btn-info sorting" data-column="8" data-direction="0" data-item="1" duration
    | &nbsp;
    a class="btn btn-info sorting" data-column="8" data-direction="0" data-item="2" core*hours
  h3 Results: #{@params[:offset]}..#{@params[:offset].to_i + @shown} of #{@total_count}
  table id="jobs" class="table table-bordered tablesorter-blue"
    thead
      tr
        th data-sorter="false"
          |
        th data-sorter="false"
          | job issues
        th
          | job id
        th
          | login
        th
          | partition
        th
          | start
        th
          | end
        th
          | state
        th
          / class="triplesort"
          | nodes
        th
          | hours
        th class='rank'
          | job size
        th
          | cpu load
        th
          | gpu load
        th
          | LA
        th
          | IPC
        th
          | MPI in (MB)
        th
          | MPI out (MB)
    - index=1
    - @jobs.each do |job|
      - index+=1
      - job_performance = job.get_performance
      - job_ranking = job.get_ranking
      - job_cond = job.get_rules @current_user
      - perf_data_present=!job_performance[:cpu_user].nil?
      tr id="job_row_#{index}" data-jobid="#{job.drms_job_id}" data-info-state="#{perf_data_present ? 0 : -1}"
        td
          input type="checkbox" class="job_check" style="display: none;" data-job-id="#{job.drms_job_id}" onChange="job_check_clicked(#{job.drms_job_id})"
          a class="button" onClick="toggle_dropdown('#job_info_#{index}');"
            i class="fas fa-bars"
          // feedback dropdown window
          div class="dropdown"
            div id="job_info_#{index}" class="dropdown-content"
              button class="close" onClick="toggle_dropdown('#job_info_#{index}');" &times;
              - if perf_data_present
                - if job_cond.size() > 0
                  - job_cond.each do |cond|
                    i class="fa-fw align-left #{@pictures.fetch(cond.name, 'far fa-exclamation-triangle')}" title="#{cond.description}"
                    | &nbsp;

                    - feedback=@jobs_plus[job.drms_job_id]['feedback']
                    i id="af-#{job.drms_job_id}-#{cond}" class="#{@agree_flags[feedback.fetch(conf,-1)]}"
                    /'fa-ok agreed-flag'
                    | &nbsp;
                    
                    a class="btn-danger" onClick="event.stopPropagation();$(this).prop('disabled','true');popup_show('hide#{job.drms_job_id}','#{cond.name}');"
                      i class="far fa-bell-slash" title="Ð¡ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾"
                    | &nbsp;

                    div class="centered-popup"
                      span class="popuptext" id="popup_hide#{job.drms_job_id}_#{cond.name}"
                        | ÐŸÐ¾ÑÑÐ½Ð¸Ñ‚Ðµ, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ?
                        input type="text" id="question_hide#{job.drms_job_id}_#{cond.name}" style="width: 90%; align: center;"
                        button class="btn-info" onClick="hide_rule('#{job.drms_job_id}','#{cond.name}');"
                          | ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ!
                        button onClick="popup_hide('hide#{job.drms_job_id}','#{cond.name}');"
                          | ÐŸÐµÑ€ÐµÐ´ÑƒÐ¼Ð°Ð»

                    a class="btn-warning disagree-button" onClick="event.stopPropagation();popup_show('disagree#{job.drms_job_id}','#{cond.name}');"
                      i class="far fa-angry" title="ÐÐµ ÑÐ¾Ð³Ð»Ð°ÑÐµÐ½!"
                    
                    div class="popup"
                      span class="popuptext" id="popup_disagree#{job.drms_job_id}_#{cond.name}"
                        | ÐŸÐ¾ÑÑÐ½Ð¸Ñ‚Ðµ, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ?
                        input type="text" id="question_#{job.drms_job_id}_#{cond.name}" style="width: 90%"
                        button class="btn-info" onClick="disagree('#{job.drms_job_id}','#{cond.name}')"
                          | ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ!
                        button onClick="popup_hide('disagree#{job.drms_job_id}','#{cond.name}');"
                          | ÐŸÐµÑ€ÐµÐ´ÑƒÐ¼Ð°Ð»
                    | #{cond.description}
                    br
                - else
                  i class="fas fa-fw fa-check"
              - else
                p 
                  | ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð·Ð°Ð´Ð°Ñ‡Ðµ :(
        td onClick="process_response(#{index},#{job.drms_job_id})"
          - if perf_data_present
            - if job_cond.size() > 0
              - job_cond.each do |cond|
                /= image_tag @pictures.fetch(cond.name, "other.png"), size: "20", alt: cond.description, title: cond.description, style: "margin: 1px"
                i class="fa-fw #{@pictures.fetch(cond.name, 'fas fa-exclamation-triangle')} inline em12" title="#{cond.description}"
            - else
              /= image_tag "ok.png", size: "20", border: 2
              i class="fas fa-fw fa-check em12"
          - else
            p 
              | no data
        /td
          button class='btn' onClick="ok_task(#{job.drms_job_id})"
            i class='fas fa-fw fa-check'
          button class='btn' onClick="notok_task(#{job.drms_job_id})"
            i class='fas fa-fw fa-times'
        td = link_to(job.drms_job_id, job)
        td = job.login
        td = job.partition
        td = job.start_time.strftime('%D %T')
        td = job.end_time.strftime('%D %T')
        td class="task_state_#{job.state} centered"
          i class="em15 #{@finish_states.fetch(job.state, 'fas fa-meh-blank')}" title="#{job.state}"
        td
          / class="sorter-metrics1"
          /| #{job.num_nodes}/#{number_with_precision(job.get_duration_hours, :precision => 1)}/#{number_with_precision(job.get_cpuh, :precision => 1)}
          = job.num_nodes
        td
          = number_with_precision(job.get_duration_hours, :precision => 1)
        /td = number_with_precision(job.get_duration_hours, :precision => 1)

        /td = number_with_precision(job.get_cpuh, :precision => 1)

        /td = "ðŸŽ–" * Math.log(job.num_nodes * (job.end_time - job.start_time) / 86400 + 2, 2).to_i

        - stars=Math.log(job.num_nodes * (job.end_time - job.start_time) / 86400 + 2, 2)
        - stars=4 if stars>4
        td
          i class="icon-signal-#{stars.to_i} em2 centered" data-stars="#{stars}"
          br
          = number_with_precision(job.get_cpuh, :precision => 1)
          /== '<i class="fas fa-star"></i>' * stars.to_i
          /== '<i class="fas fa-star-half-alt"></i>' * (stars-stars.to_i > 0.5 ? 1 : 0)

        td class="job_metric_#{job_ranking[:cpu_user]}" = number_with_precision(job_performance[:cpu_user], :precision => 1)

        td class="job_metric_#{job_ranking[:gpu_load]}" = number_with_precision(job_performance[:gpu_load], :precision => 1)

        td class="job_metric_#{job_ranking[:loadavg]}" = number_with_precision(job_performance[:loadavg], :precision => 1)

        td class="job_metric_#{job_ranking[:ipc]}" = number_with_precision(job_performance[:ipc] && job_performance[:ipc], :precision => 2)

        td class="job_metric_#{job_ranking[:ib_rcv_data_mpi]}" = number_with_precision(job_performance[:ib_rcv_data_mpi], :precision => 1)

        td class="job_metric_#{job_ranking[:ib_xmit_data_mpi]}" = number_with_precision(job_performance[:ib_xmit_data_mpi], :precision => 1)

table
  tr
    td
      - if @params[:offset].to_i >= @PER_PAGE
        a href="#{url_for @params.except(:offset).merge(offset: @params[:offset].to_i - @PER_PAGE)}" <<< prev
    td width="10px"
    td
      - if @jobs.length == 100
        a href="#{url_for @params.except(:offset).merge(offset: @params[:offset].to_i + @PER_PAGE)}" next >>>

div style="display: none"
  // disagree with rule on a job
  form id="feedback_job_rule" action="feedback_job" method="post"
    input id="user" name="user" type="text"
    //input id="account" name="account" type="text"
    input id="cluster" name="cluster" type="text"
    input id="job_id" name="job_id" type="text"
    input id="task_id" name="task_id" type="text"
    input id="condition" name="condition" type="text"
    input id="feedback" name="feedback" type="text"
  // hide rule
  form id="feedback_rule" action="feedback_rule" method="post"
    input id="user" name="user" type="text"
    input id="account" name="account" type="text"
    input id="cluster" name="cluster" type="text"
    input id="condition" name="condition" type="text"
    input id="feedback" name="feedback" type="text"
  // disagree with multiple jobs
  form id="feedback_jobs" action="feedback_jobs" method="post"
    input id="user" name="user" type="text"
    input id="jobs" name="jobs" type="text"
    input id="rules" name="rules" type="text"
    input id="feedback" name="feedback" type="text"
